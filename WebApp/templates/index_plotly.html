<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrow Configuration Calculator</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin: 20px 0;
            font-size: 32px;
            font-weight: 600;
        }
        h2 {
            color: #333;
            text-align: center;
            margin: 5px 0;
            font-size: 20px;
        }
        .main-layout {
            display: grid;
            grid-template-columns: minmax(300px, 1fr) minmax(600px, 3fr) minmax(300px, 1fr);
            gap: 20px;
            align-items: start;
            justify-content: center;
            max-width: 1800px;
            margin: 0 auto;
        }
        .setup-column {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .setup-column.setup-1 {
            border-color: #1976D2;
        }
        .setup-column.setup-2 {
            border-color: #FF9800;
        }
        .setup-title {
            text-align: center;
            margin: 0 0 10px 0;
            padding: 8px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: 500;
        }
        .setup-1 .setup-title {
            background: #E3F2FD;
            color: #1565C0;
        }
        .setup-2 .setup-title {
            background: #FFF3E0;
            color: #E65100;
        }
        .middle-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .results-section {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .results-section h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        .results-values {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        .result-item {
            background: #f5f5f5;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        .result-item .label {
            font-size: 11px;
            color: #666;
        }
        .result-item .value {
            font-size: 16px;
            font-weight: bold;
            margin-top: 2px;
        }
        .setup-1 .result-item .value {
            color: #1976D2;
        }
        .setup-2 .result-item .value {
            color: #FF9800;
        }
        .controls-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .control-group {
            flex: 1;
            min-width: 160px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .setup-1 .control-group h3 {
            border-bottom-color: #1976D2;
        }
        .setup-2 .control-group h3 {
            border-bottom-color: #FF9800;
        }
        .control-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .control-item label {
            flex: 1;
            font-size: 12px;
            color: #666;
        }
        .control-item input[type="range"] {
            flex: 1.2;
            margin: 0 8px;
            height: 20px;
        }
        .control-item .value {
            width: 40px;
            text-align: right;
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }
        .plots-container {
            display: grid;
            gap: 20px;
            width: 100%;
        }
        .plots-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .plots-row-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .plot-wrapper {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: 500px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
            font-size: 16px;
            color: #666;
        }
        .loading.show {
            display: block;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .error.show {
            display: block;
        }
        
        /* Documentation Section */
        .documentation-section {
            margin-top: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .documentation-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            text-align: center;
        }
        .doc-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        .doc-content h3 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #1976D2;
            padding-bottom: 5px;
        }
        .doc-content h4 {
            color: #666;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        .doc-content pre {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .doc-content code {
            background: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .doc-content pre code {
            background: none;
            padding: 0;
        }
        .doc-content ul, .doc-content ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        .doc-content li {
            margin-bottom: 8px;
        }
        .doc-content p {
            line-height: 1.6;
            margin: 10px 0;
        }
        .doc-content strong {
            color: #333;
        }
        
        /* Center and scale images in documentation */
        .doc-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
        }
        
        /* GitHub button */
        .github-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #24292e;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-size: 14px;
            z-index: 100;
        }
        .github-button:hover {
            background: #1a1e22;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        .github-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        /* Responsive design */
        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: minmax(280px, 1fr) minmax(500px, 2.5fr) minmax(280px, 1fr);
                gap: 15px;
            }
            .plot-wrapper {
                height: 400px;
            }
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .middle-section {
                order: 3;
            }
            .setup-column.setup-1 {
                order: 1;
            }
            .setup-column.setup-2 {
                order: 2;
            }
            .plots-row-3 {
                grid-template-columns: 1fr;
            }
            .plots-row-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Arrow Configuration Calculator</h1>
        
        <div class="main-layout">
            <!-- Setup 1 -->
            <div class="setup-column setup-1">
                <h2 class="setup-title">Setup 1</h2>
                
                <!-- Results for Setup 1 -->
                <div class="results-section" id="results1" style="display: none;">
                    <h3 style="text-align: center;">Results</h3>
                    <div class="results-values" id="resultsValues1"></div>
                </div>
                
                <div class="controls-container">
                    <!-- Bow Configuration -->
                    <div class="control-group">
                        <h3>Bow Configuration</h3>
                        <div class="control-item">
                            <label for="poundage1">Draw Weight</label>
                            <input type="range" id="poundage1" min="30" max="90" step="1" value="71">
                            <span class="value" id="poundage1Value">71</span>
                        </div>
                        <div class="control-item">
                            <label for="ibo1">IBO Speed</label>
                            <input type="range" id="ibo1" min="300" max="360" step="1" value="335">
                            <span class="value" id="ibo1Value">335</span>
                        </div>
                        <div class="control-item">
                            <label for="drawLength1">Draw Length</label>
                            <input type="range" id="drawLength1" min="24" max="32" step="0.5" value="29">
                            <span class="value" id="drawLength1Value">29</span>
                        </div>
                    </div>
                    
                    <!-- Arrow Shaft Configuration -->
                    <div class="control-group">
                        <h3>Arrow Shaft</h3>
                        <div class="control-item">
                            <label for="spine1">Spine</label>
                            <input type="range" id="spine1" min="150" max="400" step="10" value="200">
                            <span class="value" id="spine1Value">200</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowGPI1">GPI</label>
                            <input type="range" id="arrowGPI1" min="5" max="16" step="0.1" value="10.7">
                            <span class="value" id="arrowGPI1Value">10.7</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowLength1">Length</label>
                            <input type="range" id="arrowLength1" min="24" max="32" step="0.25" value="28.25">
                            <span class="value" id="arrowLength1Value">28.25</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowDiam1">Diameter</label>
                            <input type="range" id="arrowDiam1" min="0.166" max="0.300" step="0.001" value="0.166">
                            <span class="value" id="arrowDiam1Value">0.166</span>
                        </div>
                    </div>
                    
                    <!-- Nock Configuration -->
                    <div class="control-group">
                        <h3>Nock</h3>
                        <div class="control-item">
                            <label for="nockWeight1">Nock Weight</label>
                            <input type="range" id="nockWeight1" min="1" max="30" step="1" value="6">
                            <span class="value" id="nockWeight1Value">6</span>
                        </div>
                        <div class="control-item">
                            <label for="nockThroatAdder1">Nock Throat</label>
                            <input type="range" id="nockThroatAdder1" min="0" max="1" step="0.1" value="0.5">
                            <span class="value" id="nockThroatAdder1Value">0.5</span>
                        </div>
                    </div>
                    
                    <!-- Wrap Configuration -->
                    <div class="control-group">
                        <h3>Wrap</h3>
                        <div class="control-item">
                            <label for="arrowWrapWeight1">Wrap Weight</label>
                            <input type="range" id="arrowWrapWeight1" min="0" max="20" step="0.1" value="0">
                            <span class="value" id="arrowWrapWeight1Value">0</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowWrapLength1">Wrap Length</label>
                            <input type="range" id="arrowWrapLength1" min="0" max="10" step="1" value="4">
                            <span class="value" id="arrowWrapLength1Value">4</span>
                        </div>
                    </div>
                    
                    <!-- Fletching Configuration -->
                    <div class="control-group">
                        <h3>Fletching</h3>
                        <div class="control-item">
                            <label for="fletchNumber1">Number</label>
                            <input type="range" id="fletchNumber1" min="3" max="6" step="1" value="4">
                            <span class="value" id="fletchNumber1Value">4</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchWeight1">Weight Each</label>
                            <input type="range" id="fletchWeight1" min="1" max="10" step="0.1" value="5">
                            <span class="value" id="fletchWeight1Value">5</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchLength1">Length</label>
                            <input type="range" id="fletchLength1" min="1" max="5" step="0.05" value="2.25">
                            <span class="value" id="fletchLength1Value">2.25</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchHeight1">Height</label>
                            <input type="range" id="fletchHeight1" min="0.1" max="1" step="0.01" value="0.465">
                            <span class="value" id="fletchHeight1Value">0.465</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchDistance1">Distance</label>
                            <input type="range" id="fletchDistance1" min="0" max="2" step="0.05" value="0.75">
                            <span class="value" id="fletchDistance1Value">0.75</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchOffset1">Offset</label>
                            <input type="range" id="fletchOffset1" min="0" max="10" step="1" value="3">
                            <span class="value" id="fletchOffset1Value">3</span>
                        </div>
                    </div>
                    
                    <!-- Physics Configuration -->
                    <div class="control-group">
                        <h3>Physics</h3>
                        <div class="control-item">
                            <label for="coefDrag1">Drag Coef</label>
                            <input type="range" id="coefDrag1" min="0.1" max="3" step="0.1" value="2">
                            <span class="value" id="coefDrag1Value">2</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Middle Section with Plots -->
            <div class="middle-section">
                <div class="loading">
                    <p>Calculating...</p>
                </div>
                
                <div class="error" id="error"></div>
                
                <div class="plots-container" id="plots"></div>
            </div>
            
            <!-- Setup 2 -->
            <div class="setup-column setup-2">
                <h2 class="setup-title">Setup 2</h2>
                
                <!-- Results for Setup 2 -->
                <div class="results-section" id="results2" style="display: none;">
                    <h3 style="text-align: center;">Results</h3>
                    <div class="results-values" id="resultsValues2"></div>
                </div>
                
                <div class="controls-container">
                    <!-- Bow Configuration -->
                    <div class="control-group">
                        <h3>Bow Configuration</h3>
                        <div class="control-item">
                            <label for="poundage2">Draw Weight</label>
                            <input type="range" id="poundage2" min="30" max="90" step="1" value="71">
                            <span class="value" id="poundage2Value">71</span>
                        </div>
                        <div class="control-item">
                            <label for="ibo2">IBO Speed</label>
                            <input type="range" id="ibo2" min="300" max="360" step="1" value="335">
                            <span class="value" id="ibo2Value">335</span>
                        </div>
                        <div class="control-item">
                            <label for="drawLength2">Draw Length</label>
                            <input type="range" id="drawLength2" min="24" max="32" step="0.5" value="29">
                            <span class="value" id="drawLength2Value">29</span>
                        </div>
                    </div>
                    
                    <!-- Arrow Shaft Configuration -->
                    <div class="control-group">
                        <h3>Arrow Shaft</h3>
                        <div class="control-item">
                            <label for="spine2">Spine</label>
                            <input type="range" id="spine2" min="150" max="400" step="10" value="300">
                            <span class="value" id="spine2Value">300</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowGPI2">GPI</label>
                            <input type="range" id="arrowGPI2" min="5" max="16" step="0.1" value="7.1">
                            <span class="value" id="arrowGPI2Value">7.1</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowLength2">Length</label>
                            <input type="range" id="arrowLength2" min="24" max="32" step="0.25" value="28.25">
                            <span class="value" id="arrowLength2Value">28.25</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowDiam2">Diameter</label>
                            <input type="range" id="arrowDiam2" min="0.166" max="0.300" step="0.001" value="0.166">
                            <span class="value" id="arrowDiam2Value">0.166</span>
                        </div>
                    </div>
                    
                    <!-- Nock Configuration -->
                    <div class="control-group">
                        <h3>Nock</h3>
                        <div class="control-item">
                            <label for="nockWeight2">Nock Weight</label>
                            <input type="range" id="nockWeight2" min="1" max="30" step="1" value="6">
                            <span class="value" id="nockWeight2Value">6</span>
                        </div>
                        <div class="control-item">
                            <label for="nockThroatAdder2">Nock Throat</label>
                            <input type="range" id="nockThroatAdder2" min="0" max="1" step="0.1" value="0.5">
                            <span class="value" id="nockThroatAdder2Value">0.5</span>
                        </div>
                    </div>
                    
                    <!-- Wrap Configuration -->
                    <div class="control-group">
                        <h3>Wrap</h3>
                        <div class="control-item">
                            <label for="arrowWrapWeight2">Wrap Weight</label>
                            <input type="range" id="arrowWrapWeight2" min="0" max="20" step="0.1" value="0">
                            <span class="value" id="arrowWrapWeight2Value">0</span>
                        </div>
                        <div class="control-item">
                            <label for="arrowWrapLength2">Wrap Length</label>
                            <input type="range" id="arrowWrapLength2" min="0" max="10" step="1" value="4">
                            <span class="value" id="arrowWrapLength2Value">4</span>
                        </div>
                    </div>
                    
                    <!-- Fletching Configuration -->
                    <div class="control-group">
                        <h3>Fletching</h3>
                        <div class="control-item">
                            <label for="fletchNumber2">Number</label>
                            <input type="range" id="fletchNumber2" min="3" max="6" step="1" value="4">
                            <span class="value" id="fletchNumber2Value">4</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchWeight2">Weight Each</label>
                            <input type="range" id="fletchWeight2" min="1" max="10" step="0.1" value="5">
                            <span class="value" id="fletchWeight2Value">5</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchLength2">Length</label>
                            <input type="range" id="fletchLength2" min="1" max="5" step="0.05" value="2.25">
                            <span class="value" id="fletchLength2Value">2.25</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchHeight2">Height</label>
                            <input type="range" id="fletchHeight2" min="0.1" max="1" step="0.01" value="0.465">
                            <span class="value" id="fletchHeight2Value">0.465</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchDistance2">Distance</label>
                            <input type="range" id="fletchDistance2" min="0" max="2" step="0.05" value="0.75">
                            <span class="value" id="fletchDistance2Value">0.75</span>
                        </div>
                        <div class="control-item">
                            <label for="fletchOffset2">Offset</label>
                            <input type="range" id="fletchOffset2" min="0" max="10" step="1" value="3">
                            <span class="value" id="fletchOffset2Value">3</span>
                        </div>
                    </div>
                    
                    <!-- Physics Configuration -->
                    <div class="control-group">
                        <h3>Physics</h3>
                        <div class="control-item">
                            <label for="coefDrag2">Drag Coef</label>
                            <input type="range" id="coefDrag2" min="0.1" max="3" step="0.1" value="2">
                            <span class="value" id="coefDrag2Value">2</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Documentation Section -->
    <div class="documentation-section">
        <div class="doc-content" id="readme-content">
            <p>Loading documentation...</p>
        </div>
    </div>
    
    <!-- GitHub button -->
    <a href="https://github.com/ahilario/ArrowCalculator" target="_blank" class="github-button">
        <svg viewBox="0 0 16 16" aria-hidden="true">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
        </svg>
        View on GitHub
    </a>
    
    <script>
        let updateTimer = null;
        let isCalculating = false;
        
        // Update all slider values
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            const valueSpan = document.getElementById(slider.id + 'Value');
            
            // Update value display immediately
            slider.addEventListener('input', () => {
                valueSpan.textContent = slider.value;
            });
            
            // Calculate on both input (while dragging) and change (on release)
            slider.addEventListener('input', () => {
                if (!isCalculating) {
                    clearTimeout(updateTimer);
                    updateTimer = setTimeout(calculate, 100); // Faster debounce for smoother updates
                }
            });
            
            // Immediate calculation on mouse release
            slider.addEventListener('change', () => {
                clearTimeout(updateTimer);
                calculate();
            });
        });
        
        // Calculate on page load
        window.addEventListener('load', () => {
            setTimeout(calculate, 500);
        });
        
        async function calculate() {
            if (isCalculating) return;
            isCalculating = true;
            
            const loading = document.querySelector('.loading');
            const error = document.getElementById('error');
            const results1 = document.getElementById('results1');
            const results2 = document.getElementById('results2');
            
            // Only show loading for longer operations
            const loadingTimeout = setTimeout(() => {
                loading.classList.add('show');
            }, 200);
            error.classList.remove('show');
            
            // Gather parameters for both setups
            const params = {
                setup1: gatherParams('1'),
                setup2: gatherParams('2')
            };
            
            try {
                const response = await fetch('/calculate_comparison', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results for both setups
                    displayResults(data.setup1.values, 'resultsValues1');
                    displayResults(data.setup2.values, 'resultsValues2');
                    
                    // Display comparison plots
                    displayPlots(data.plots);
                    
                    results1.style.display = 'block';
                    results2.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Calculation failed');
                }
            } catch (err) {
                error.textContent = 'Error: ' + err.message;
                error.classList.add('show');
            } finally {
                clearTimeout(loadingTimeout);
                loading.classList.remove('show');
                isCalculating = false;
            }
        }
        
        function gatherParams(suffix) {
            return {
                poundage: parseFloat(document.getElementById('poundage' + suffix).value),
                ibo: parseFloat(document.getElementById('ibo' + suffix).value),
                drawLength: parseFloat(document.getElementById('drawLength' + suffix).value),
                spine: parseFloat(document.getElementById('spine' + suffix).value),
                arrowGPI: parseFloat(document.getElementById('arrowGPI' + suffix).value),
                arrowLength: parseFloat(document.getElementById('arrowLength' + suffix).value),
                arrowDiam: parseFloat(document.getElementById('arrowDiam' + suffix).value),
                nockWeight: parseFloat(document.getElementById('nockWeight' + suffix).value),
                nockThroatAdder: parseFloat(document.getElementById('nockThroatAdder' + suffix).value),
                arrowWrapWeight: parseFloat(document.getElementById('arrowWrapWeight' + suffix).value),
                arrowWrapLength: parseFloat(document.getElementById('arrowWrapLength' + suffix).value),
                fletchNumber: parseInt(document.getElementById('fletchNumber' + suffix).value),
                fletchWeight: parseFloat(document.getElementById('fletchWeight' + suffix).value),
                fletchLength: parseFloat(document.getElementById('fletchLength' + suffix).value),
                fletchHeight: parseFloat(document.getElementById('fletchHeight' + suffix).value),
                fletchDistance: parseFloat(document.getElementById('fletchDistance' + suffix).value),
                fletchOffset: parseFloat(document.getElementById('fletchOffset' + suffix).value),
                coefDrag: parseFloat(document.getElementById('coefDrag' + suffix).value)
            };
        }
        
        function displayResults(values, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="result-item">
                    <div class="label">Point Weight</div>
                    <div class="value">${values.optimalPointWeight.toFixed(0)}gr</div>
                </div>
                <div class="result-item">
                    <div class="label">Total Mass</div>
                    <div class="value">${values.totalArrowMass.toFixed(0)}gr</div>
                </div>
                <div class="result-item">
                    <div class="label">FOC</div>
                    <div class="value">${values.foc.toFixed(1)}%</div>
                </div>
                <div class="result-item">
                    <div class="label">Velocity</div>
                    <div class="value">${values.fps.toFixed(0)}fps</div>
                </div>
                <div class="result-item">
                    <div class="label">KE</div>
                    <div class="value">${values.ke.toFixed(0)}J</div>
                </div>
                <div class="result-item">
                    <div class="label">Momentum</div>
                    <div class="value">${values.momentum.toFixed(2)}</div>
                </div>
            `;
        }
        
        function displayPlots(plots) {
            const plotsContainer = document.getElementById('plots');
            plotsContainer.innerHTML = '';
            
            // First row - 3 graphs
            const row1 = document.createElement('div');
            row1.className = 'plots-row-3';
            plotsContainer.appendChild(row1);
            
            const firstRowPlots = ['pointWeight', 'totalMass', 'foc'];
            firstRowPlots.forEach(plotName => {
                if (plots[plotName]) {
                    const plotDiv = document.createElement('div');
                    plotDiv.className = 'plot-wrapper';
                    plotDiv.id = `plot-${plotName}`;
                    row1.appendChild(plotDiv);
                }
            });
            
            // Remaining rows - 2 graphs per row
            const remainingPlots = ['fps', 'ke', 'momentum', 'tof'];
            for (let i = 0; i < remainingPlots.length; i += 2) {
                const row = document.createElement('div');
                row.className = 'plots-row-2';
                plotsContainer.appendChild(row);
                
                for (let j = i; j < Math.min(i + 2, remainingPlots.length); j++) {
                    const plotName = remainingPlots[j];
                    if (plots[plotName]) {
                        const plotDiv = document.createElement('div');
                        plotDiv.className = 'plot-wrapper';
                        plotDiv.id = `plot-${plotName}`;
                        row.appendChild(plotDiv);
                    }
                }
            }
            
            // Now render all plots
            const plotOrder = ['pointWeight', 'totalMass', 'foc', 'fps', 'ke', 'momentum', 'tof'];
            plotOrder.forEach(plotName => {
                if (plots[plotName]) {
                    const plotData = JSON.parse(plots[plotName]);
                    Plotly.newPlot(`plot-${plotName}`, plotData.data, plotData.layout, {
                        responsive: true,
                        displayModeBar: false
                    });
                }
            });
        }
        
        // Load and render README.md
        async function loadReadme() {
            try {
                const response = await fetch('/readme');
                const data = await response.json();
                
                if (data.success) {
                    const readmeContainer = document.getElementById('readme-content');
                    
                    // Split content into sections
                    let content = data.content;
                    
                    // Remove the Equations section and everything after it
                    const equationsIndex = content.indexOf('# Equations');
                    if (equationsIndex !== -1) {
                        content = content.substring(0, equationsIndex);
                    }
                    
                    // Extract references/assumptions section to move to bottom
                    let assumptionsContent = '';
                    const assumptionsIndex = content.indexOf('# Assumptions');
                    if (assumptionsIndex !== -1) {
                        assumptionsContent = content.substring(assumptionsIndex);
                        content = content.substring(0, assumptionsIndex);
                    }
                    
                    // Remove Future Work section
                    const futureWorkIndex = content.indexOf('# Future Work');
                    if (futureWorkIndex !== -1) {
                        const nextSectionIndex = content.indexOf('\n# ', futureWorkIndex + 1);
                        if (nextSectionIndex !== -1) {
                            content = content.substring(0, futureWorkIndex) + content.substring(nextSectionIndex);
                        } else {
                            content = content.substring(0, futureWorkIndex);
                        }
                    }
                    
                    // Remove How to run Arrow Calculator section
                    const howToRunIndex = content.indexOf('# How to run Arrow Calculator');
                    if (howToRunIndex !== -1) {
                        const nextSectionIndex = content.indexOf('\n# ', howToRunIndex + 1);
                        if (nextSectionIndex !== -1) {
                            content = content.substring(0, howToRunIndex) + content.substring(nextSectionIndex);
                        } else {
                            content = content.substring(0, howToRunIndex);
                        }
                    }
                    
                    // Remove any Legend sections
                    const legendIndex = content.indexOf('### Legend');
                    if (legendIndex !== -1) {
                        // Find the end of the legend section (next heading or end of content)
                        const nextHeadingMatch = content.substring(legendIndex).match(/\n#/);
                        if (nextHeadingMatch) {
                            const endIndex = legendIndex + nextHeadingMatch.index;
                            content = content.substring(0, legendIndex) + content.substring(endIndex);
                        } else {
                            content = content.substring(0, legendIndex);
                        }
                    }
                    
                    // Extract references from content
                    let references = [];
                    
                    // Find Ashby reference
                    const ashbyMatch = content.match(/\(per Ashby Reports[^)]+\)/);
                    if (ashbyMatch) {
                        references.push('Ashby Reports (2019). Terminal Arrow Performance Update. https://static1.squarespace.com/static/5d0443b188b6c900011e0ccc/t/5e9378b48f4a085e431232d4/1586722996915/2019+Terminal+Arrow+Performance+Update.pdf');
                        content = content.replace(ashbyMatch[0], '');
                    }
                    
                    // Find and remove the exact Meyer reference text
                    const meyerText = "Per the whitepaper: Meyer, H.O. (2015) Applications of Physics to Archery https://arxiv.org/pdf/1511.02250.pdf";
                    if (content.includes(meyerText)) {
                        references.push('Meyer, H.O. (2015). Applications of Physics to Archery. https://arxiv.org/pdf/1511.02250.pdf');
                        content = content.replace(meyerText, '');
                    }
                    
                    // Also check in assumptions content
                    if (assumptionsContent.includes(meyerText)) {
                        if (!references.includes('Meyer, H.O. (2015). Applications of Physics to Archery. https://arxiv.org/pdf/1511.02250.pdf')) {
                            references.push('Meyer, H.O. (2015). Applications of Physics to Archery. https://arxiv.org/pdf/1511.02250.pdf');
                        }
                        assumptionsContent = assumptionsContent.replace(meyerText, '');
                    }
                    
                    // Also try with period at the end
                    const meyerTextWithPeriod = meyerText + ".";
                    if (content.includes(meyerTextWithPeriod)) {
                        if (!references.includes('Meyer, H.O. (2015). Applications of Physics to Archery. https://arxiv.org/pdf/1511.02250.pdf')) {
                            references.push('Meyer, H.O. (2015). Applications of Physics to Archery. https://arxiv.org/pdf/1511.02250.pdf');
                        }
                        content = content.replace(meyerTextWithPeriod, '');
                    }
                    
                    // Also check in assumptions content with period
                    if (assumptionsContent.includes(meyerTextWithPeriod)) {
                        if (!references.includes('Meyer, H.O. (2015). Applications of Physics to Archery. https://arxiv.org/pdf/1511.02250.pdf')) {
                            references.push('Meyer, H.O. (2015). Applications of Physics to Archery. https://arxiv.org/pdf/1511.02250.pdf');
                        }
                        assumptionsContent = assumptionsContent.replace(meyerTextWithPeriod, '');
                    }
                    
                    // Clean up any remaining reference artifacts in both content sections
                    content = content.replace(/\s*Per the whitepaper:\s*/g, ' ');
                    content = content.replace(/\(\s*\)/g, ''); // Remove empty parentheses
                    content = content.replace(/\s+\./g, '.'); // Fix spacing before periods
                    content = content.replace(/\.\s*\./g, '.'); // Remove double periods
                    
                    assumptionsContent = assumptionsContent.replace(/\s*Per the whitepaper:\s*/g, ' ');
                    assumptionsContent = assumptionsContent.replace(/\(\s*\)/g, ''); // Remove empty parentheses
                    assumptionsContent = assumptionsContent.replace(/\s+\./g, '.'); // Fix spacing before periods
                    assumptionsContent = assumptionsContent.replace(/\.\s*\./g, '.'); // Remove double periods
                    assumptionsContent = assumptionsContent.replace(/,\s*but feel free to play around with it\.\s*/g, ', but feel free to play around with it'); // Clean up drag coefficient line
                    
                    // Build final content with sections
                    content = content + '\n\n' + assumptionsContent;
                    
                    // Add references section if we found any
                    if (references.length > 0) {
                        content += '\n\n# References\n\n';
                        references.forEach(ref => {
                            content += '* ' + ref + '\n';
                        });
                    }
                    
                    // Convert markdown to HTML
                    const htmlContent = marked.parse(content);
                    
                    // Fix image paths
                    const fixedContent = htmlContent.replace(/src="\.\/([^"]+)"/g, 'src="/images/$1"');
                    
                    readmeContainer.innerHTML = fixedContent;
                    
                    // Apply styling to code blocks
                    readmeContainer.querySelectorAll('pre code').forEach(block => {
                        block.style.whiteSpace = 'pre-wrap';
                        block.style.wordBreak = 'break-word';
                    });
                } else {
                    console.error('Failed to load README:', data.error);
                }
            } catch (error) {
                console.error('Error loading README:', error);
                document.getElementById('readme-content').innerHTML = '<p>Error loading documentation.</p>';
            }
        }
        
        // Load README when page loads
        window.addEventListener('load', () => {
            loadReadme();
        });
    </script>
</body>
</html>